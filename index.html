<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React via CDN</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React and ReactDOM -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>

    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Your React code using JSX -->
    <script type="text/babel">
      const baseURL = "https://4lkpz2tl-3000.inc1.devtunnels.ms/api";
      const orgAPIKey = "8c3c2b05dfdd6a330db4d9be8971194c24a36757b8c25d3190";
      const videoId = "caecc04dddfcd4d9adacb1a4d922567c";
      const UserContext = React.createContext();

      const Login = () => {
        const { setUserId } = React.useContext(UserContext);

        const handleSubmit = (e) => {
          e.preventDefault();

          const email = e.target.email.value; // Get entered email
          localStorage.setItem("userID", email); // Save to localStorage
          setUserId(email); // Set in context
        };

        return (
          <div
            className="container-fluid login-container d-flex align-items-center justify-content-center bg-light"
            style={{ height: "100vh" }}
          >
            <div
              className="card p-4 shadow"
              style={{ minWidth: "300px", maxWidth: "400px", width: "100%" }}
            >
              <h3 className="text-center mb-4">Login</h3>
              <form onSubmit={handleSubmit}>
                <div className="mb-3">
                  <label htmlFor="email" className="form-label">
                    Email address
                  </label>
                  <input
                    type="email"
                    className="form-control"
                    id="email"
                    name="email"
                    placeholder="Enter email"
                    required
                  />
                </div>
                <div className="d-grid">
                  <button type="submit" className="btn btn-primary">
                    Login
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const VideoPlayer = ({ url }) => {
        return (
          <div className="border d-inline-block">
            <iframe
              src={url}
              allow="encrypted-media"
              frameBorder="0"
              width="500"
              height="300"
            ></iframe>
          </div>
        );
      };

      const Home = () => {
        const [videoUrl, setVideoUrl] = React.useState("");

        const getStoredTokens = () => ({
          accessToken: localStorage.getItem("accessToken"),
          refreshToken: localStorage.getItem("refreshToken"),
          userID: localStorage.getItem("userID"),
        });

        async function registerUser(userId, onSuccess, onError) {
          const url = `${baseURL}/user/register`;
          const headers = {
            "X-Organization-Key": orgAPIKey,
            "Content-Type": "application/json",
          };

          const payload = { user_id: userId };

          try {
            const response = await fetch(url, {
              method: "POST",
              headers,
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.message ||
                  `Request failed with status ${response.status}`
              );
            }

            const data = await response.json();
            if (onSuccess) onSuccess(data);
            return data;
          } catch (error) {
            console.error("Registration error:", error);
            if (onError) onError(error);
            throw error;
          }
        }

        async function fetchVideoDetails(videoId, accessToken) {
          const url = `${baseURL}/vdo/${videoId}`;

          const headers = {
            Authorization: accessToken,
          };

          try {
            const response = await fetch(url, {
              method: "GET",
              headers,
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.message ||
                  `Request failed with status ${response.status}`
              );
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error("Fetch video details error:", error);
            throw error;
          }
        }

        async function refreshAccessToken(refreshToken) {
          const url = `${baseURL}/user/refresh`;

          const headers = {
            Authorization: refreshToken,
          };

          try {
            const response = await fetch(url, {
              method: "GET",
              headers,
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.message || `Token refresh failed (${response.status})`
              );
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error("Refresh token failed:", error);
            throw error;
          }
        }

        const getVideoUrl = async (vdoId) => {
          const { accessToken, refreshToken, userID } = getStoredTokens();

          if (!accessToken && !refreshToken) {
            try {
              const result = await registerUser(userID);
              if (result?.accessToken && result?.refreshToken) {
                localStorage.setItem("accessToken", result?.accessToken);
                localStorage.setItem("refreshToken", result?.refreshToken);
                getVideoUrl(vdoId);
              } else {
                alert("Registration failed: " + "Wrong data recived");
              }
            } catch (err) {
              alert("Registration failed: " + err.message);
            }
          } else if (accessToken) {
            try {
              const videoData = await fetchVideoDetails(videoId, accessToken);
              setVideoUrl(videoData?.iframeSrc);
            } catch (error) {
              localStorage.removeItem("accessToken");
              getVideoUrl(vdoId);
            }
          } else if (refreshToken) {
            try {
              const tokenData = await refreshAccessToken(refreshToken);
              localStorage.setItem("accessToken", tokenData?.accessToken);
              localStorage.setItem("refreshToken", tokenData?.refreshToken);
              getVideoUrl(vdoId);
            } catch (error) {}
          }
        };

        return (
          <div>
            {videoUrl && <VideoPlayer url={videoUrl} />}
            <div className="py-2">
              <button
                onClick={() => getVideoUrl("nb")}
                className="btn btn-primary"
              >
                Play Video
              </button>
            </div>
          </div>
        );
      };

      const App = () => {
        const { userId } = React.useContext(UserContext);
        return userId ? <Home /> : <Login />;
      };

      const Main = () => {
        const [userId, setUserId] = React.useState(
          localStorage.getItem("userID")
        );
        return (
          <UserContext.Provider value={{ userId, setUserId }}>
            <App />
          </UserContext.Provider>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Main />);
    </script>
  </body>
</html>
